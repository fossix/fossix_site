{% extends 'base.html' %}

{% from 'utils.html' import print_author, tag_detail %}
{% from "utils.html" import render_field, perror %}

{% set pagetitle=content.title %}

{% block content %}
<div class="contenthead">
  By
  {% if content.author %}
    {{ print_author(content.author) }}
  {% else %}
    Anonymous
  {% endif %}
  on
  {{ content.get_create_date() }}
  {% if g.user.is_authenticated() and g.user.is_editor(content) %}
    <a href="{{ url_for('content.EditView:get', id=content.id) }}" id="edit">
      <button class="btn btn-mini"><i class="icon-edit"> </i></button></a>
  {% endif %}
  <span class="badge badge-inverse pull-right" id="likecount">
    {{content.like_count}}
  </span>
  <a href="{{ url_for('content.ContentView:vote', id=content.id, vote='up') }}"
     class="pull-right" id="like">
    <button class="btn btn-mini"><i class="icon-thumbs-up"> </i>Like</button>
  </a>
</div>

<div class="content-body">
  {{ content.content | markdown }}
</div>

<div class="span12">
  <div class="taglist pull-left">
    {% for t in content.tags %}
      {{ tag_detail(t) }}
    {% endfor %}
  </div>

  {% if g.user.is_authenticated() %}
    <div class="read-count pull-right">
      Number of reads: {{ content.read_count }}
    </div>
  {% endif %}
</div>

<div class="span12">
  <div class="pull-right">
    {% if content.version > 1 %}
      <a href="#" data-toggle="tooltip" class="tip"
         title="Version {{content.version}}: {{content.edit_summary}}">
        Modified {{content.modified_date | relative_now}} ago
      </a>
      by
      {{ print_author(content.author) }}
    {% endif %}
  </div>
</div>

{% if g.user.is_authenticated() %}
  <form method="POST" id="comment_form">
    {{ comment.hidden_tag() }}
    {{ render_field(comment.content, rows=4, required=True, class="span12") }}
    <input type="submit" value="Comment" name="submit"
           formaction="{{request.path}}">
    {{ perror(comment.errors) }}
  </form>
{% else %}
  Login to Comment
{% endif %}
<hr>
{% if content.comments %}
{% if content.comment_count > 1 %}
  <h3> {{content.comment_count}} Comments </h3>
{% elif content.comment_count == 0 %}
  <h3> No comments yet </h3>
{% else %}
  <h3> {{content.comment_count}} Comment </h3>
{% endif %}
{%- for comment in content.comments recursive %}
<div class="media">
  <div class="pull-left tooltips rounded"
       title="{{comment.author.username}}" data-toggle="tooltip"
       data-placement="top">
    <img class="media-object" src="{{comment.author.avatar(64)}}" />
  </div>

  <div class="media-body">
    <div class="row-fluid">
      <div class="span11">
        <h4 class="media-heading">
          {% if comment.author.website %}
            <a href="{{comment.author.website}}">
              {{comment.author.username|capitalize}}
            </a>
          {% else %}
            {{comment.author.username|capitalize}}
          {% endif %}
        </h4>

        <blockquote>
          {{ comment.content }}
        </blockquote>
      </div>

      <div class="span1">
        {% if g.user.is_authenticated() %}
        <a href="#" data-url="{{ url_for('content.ContentView:vote',
                              id=comment.id, vote='up') }}"
           class="vote" id="{{comment.id}}">
          <i class="icon-thumbs-up"> </i>
        </a>
        {% endif %}
        <br>
        <span class="badge badge-inverse"
              id="vote_count{{comment.id}}">
          {{comment.like_count}}
        </span>
        <br>
        {% if g.user.is_authenticated() %}
        <a href="#" data-url="{{ url_for('content.ContentView:vote',
                              id=comment.id, vote='down') }}"
           class="vote" id="{{comment.id}}">
          <i class="icon-thumbs-down"> </i>
        </a>
        {% endif %}
      </div>
    </div>
    <a href="#" class="span12">Reply</a>
    {%- if comment.comments -%}
    {{ loop(comment.comments) }}
    {%- endif %}
  </div>
</div>
{%- endfor %}
{% endif %}
{% endblock %}
